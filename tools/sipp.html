<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary SEO -->
  <title>SIPP Projection Tool – CyberAlex</title>
  <meta name="description" content="UK SIPP projection calculator with transparent assumptions and a full month-by-month audit trail. Estimate low/mid/high outcomes at your chosen access age (defaulting to the earliest allowed under UK rules). Local-only, no tracking.">
  <meta name="author" content="Alex">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.cyberalex.uk/tools/sipp-projection.html">

  <!-- Open Graph -->
  <meta property="og:title" content="SIPP Projection Tool – CyberAlex">
  <meta property="og:description" content="Project a UK SIPP with clear assumptions, low/mid/high outcomes, and a complete auditable month-by-month schedule. Runs locally in your browser.">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="CyberAlex">
  <meta property="og:image" content="https://www.cyberalex.uk/img/social-card.png">

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SIPP Projection Tool – CyberAlex">
  <meta name="twitter:description" content="A transparent UK SIPP projection tool with full workings and a month-by-month audit trail. Local-only.">
  <meta name="twitter:image" content="https://www.cyberalex.uk/img/social-card.png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="icon" href="/logo.png" type="image/png">

  <!-- Optional: small page-local tweaks without touching main.css -->
  <style>
    .kpi { font-variant-numeric: tabular-nums; }
    .table-audit th, .table-audit td { vertical-align: top; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .chip {
      display: inline-block;
      padding: .1rem .45rem;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      font-size: .75rem;
      color: rgba(255,255,255,.75);
      margin-right: .35rem;
    }
    .help-q {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;height:18px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.25);
      font-size:12px;
      line-height:1;
      margin-left:.35rem;
      cursor:pointer;
      user-select:none;
    }
    .audit-wrap {
      max-height: 420px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: .75rem;
    }
  </style>
</head>

<body class="theme-dark">
<a class="skip-link" href="#main-content">Skip to main content</a>

<header id="site-header"></header>

<main id="main-content" class="container py-4" tabindex="-1">

  <!-- PAGE HEADER -->
  <section class="mb-4" aria-label="Page header">
    <nav aria-label="Breadcrumb" class="mb-2">
      <ol class="breadcrumb small mb-0">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/projects.html">Tools &amp; Projects</a></li>
        <li class="breadcrumb-item active" aria-current="page">SIPP Projection Tool</li>
      </ol>
    </nav>

    <h1 class="h3 mb-1">SIPP Projection Tool</h1>
    <p class="text-secondary small mb-0">
      By <a href="/about.html">Alex</a> &bull; Published: 13 June 2025 &bull; Updated: 23 December 2025
    </p>
  </section>

  <!-- HERO / SUMMARY ROW (SEO-important content comes early) -->
  <section class="mb-4">
    <div class="row g-4 align-items-start">
      <div class="col-lg-7">
        <p class="lead mb-2">
          A transparent, UK-aware tool for estimating what a Self-Invested Personal Pension (SIPP)
          <em>could</em> be worth at your chosen access age (defaulting to the earliest age allowed under current rules).
        </p>
        <p class="small text-secondary mb-2">
          Educational projection only — not regulated financial advice. The calculator shows its full assumptions and a
          complete month-by-month audit trail so the maths can be checked.
        </p>
        <div class="small text-secondary">
          <span class="chip">Local-only</span>
          <span class="chip">No tracking</span>
          <span class="chip">Low / Mid / High</span>
          <span class="chip">Full audit trail</span>
        </div>
      </div>

      <!-- AT A GLANCE -->
      <div class="col-lg-5">
        <div class="card h-100 card-raise">
          <div class="card-body small text-secondary">
            <h2 class="h6 text-uppercase text-muted mb-2">At a Glance</h2>
            <ul class="mb-2">
              <li>Uses UK minimum pension access rules (with clear limitations).</li>
              <li>Models <strong>net vs gross</strong> contributions (basic-rate relief at source for “net”).</li>
              <li>Outputs <strong>low / mid / high</strong> outcomes — not false precision.</li>
              <li>Provides a <strong>month-by-month schedule</strong> you can audit or export to CSV.</li>
            </ul>
            <p class="mb-0">
              <strong>Privacy:</strong> everything runs in your browser. No data is sent anywhere.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PRIVACY STATEMENT (short, early) -->
  <section class="mb-5" aria-labelledby="privacy-heading">
    <h2 id="privacy-heading" class="h5 mb-2">Privacy</h2>
    <p class="small text-secondary mb-0">
      This tool runs entirely on your device. Inputs (DOB, pot size, contributions, assumptions) are processed locally in JavaScript and are not transmitted to a server.
      There are no analytics calls in this page logic.
    </p>
  </section>

  <!-- TOOL UI -->
  <section class="mb-5" aria-labelledby="tool-heading">
    <h2 id="tool-heading" class="h4 mb-3">Your details</h2>

    <div class="card card-raise">
      <div class="card-body">
        <form class="row g-3" autocomplete="off" aria-label="SIPP projection input form">

          <!-- DOB -->
          <div class="col-md-4">
            <label class="form-label small" for="dob">Date of birth</label>
            <input type="date" id="dob" class="form-control form-control-sm">
            <div class="form-text small">
              Used to remove age-rounding errors and to auto-fill the earliest access age under current rules.
            </div>
          </div>

          <!-- Current SIPP -->
          <div class="col-md-4">
            <label class="form-label small" for="currentPot">Current SIPP value (£)</label>
            <input type="number" id="currentPot" class="form-control form-control-sm" value="0" min="0" step="100">
          </div>

          <!-- Contribution -->
          <div class="col-md-4">
            <label class="form-label small" for="contribution">Monthly contribution (£)</label>
            <input type="number" id="contribution" class="form-control form-control-sm" value="0" min="0" step="10">
          </div>

          <!-- Net/Gross -->
          <div class="col-md-6">
            <label class="form-label small" for="contributionType">Contribution type</label>
            <select id="contributionType" class="form-select form-select-sm">
              <option value="net" selected>Net (what leaves my bank)</option>
              <option value="gross">Gross (what goes into the pension)</option>
            </select>
            <div class="form-text small">
              <strong>Net</strong> means “I pay £X from my bank”. SIPPs usually add basic-rate tax relief at source.
              <strong>Gross</strong> means “£X lands in the pension after relief”.
            </div>
          </div>

          <!-- Income (optional) -->
          <div class="col-md-6">
            <label class="form-label small" for="income">Annual income (£) <span class="text-muted">(optional)</span></label>
            <input type="number" id="income" class="form-control form-control-sm" min="0" step="1000">
            <div class="form-text small">
              If left blank, the tool assumes only basic-rate relief at source for net contributions.
              This tool does not attempt to calculate higher/additional-rate relief reclaim.
            </div>
          </div>

          <!-- Growth -->
          <div class="col-md-4">
            <label class="form-label small" for="growth">Expected annual return (%)</label>
            <input type="number" id="growth" class="form-control form-control-sm" value="5.0" min="0.1" max="20.0" step="0.1">
            <div class="form-text small">
              A modelling assumption — not a prediction.
            </div>
          </div>

          <!-- Variance -->
          <div class="col-md-4">
            <label class="form-label small" for="variance">Variance (+/- %)</label>
            <input type="number" id="variance" class="form-control form-control-sm" value="3.0" min="0.0" max="10.0" step="0.1">
            <div class="form-text small">
              Low = (growth − variance), High = (growth + variance).
            </div>
          </div>

          <!-- Access age -->
          <div class="col-md-4">
            <label class="form-label small" for="retirementAge">
              Access age
              <span class="help-q" role="button" tabindex="0" aria-label="Help: access age" data-help="accessAge">?</span>
            </label>
            <input type="number" id="retirementAge" class="form-control form-control-sm" min="55" step="1">
            <div class="form-text small">
              Auto-fills to the earliest access age allowed under current rules, but you can increase it.
            </div>
          </div>

          <div class="col-12 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary btn-sm" onclick="calculate()">Calculate projection</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadCSV()" id="csvBtn" disabled>Download audit trail (CSV)</button>
          </div>

          <!-- inline help toast-ish -->
          <div class="col-12 d-none" id="inlineHelp">
            <div class="alert alert-secondary small mb-0" role="alert">
              <strong id="inlineHelpTitle">Help</strong>
              <div id="inlineHelpText" class="mt-1"></div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="mb-5 d-none" aria-labelledby="results-heading">
    <h2 id="results-heading" class="h4 mb-3">Projected outcome</h2>

    <p class="mb-2">
      Based on the information you provided, at age
      <strong><span id="outAge"></span></strong>
      your SIPP could be worth approximately:
    </p>

    <ul class="mb-3 kpi">
      <li><strong>Low (cautious):</strong> £<span id="lowOut"></span></li>
      <li><strong>Mid (expected):</strong> £<span id="midOut"></span></li>
      <li><strong>High (optimistic):</strong> £<span id="highOut"></span></li>
    </ul>

    <details class="mb-3">
      <summary class="mb-2">Show workings (audit trail)</summary>

      <div class="small text-secondary mb-3" id="workings"></div>

      <div class="mb-2 d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setAuditView('low')">View low schedule</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setAuditView('mid')">View mid schedule</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setAuditView('high')">View high schedule</button>
      </div>

      <div class="audit-wrap">
        <table class="table table-sm table-dark table-striped mb-0 table-audit" aria-label="Month-by-month audit table">
          <thead>
            <tr>
              <th scope="col">Month</th>
              <th scope="col">Age</th>
              <th scope="col">Start (£)</th>
              <th scope="col">Growth (£)</th>
              <th scope="col">Contribution (£)</th>
              <th scope="col">End (£)</th>
            </tr>
          </thead>
          <tbody id="auditBody"></tbody>
        </table>
      </div>

      <p class="small text-secondary mt-2 mb-0">
        Tip: use <strong>Download audit trail (CSV)</strong> to review the full schedule in Excel.
      </p>
    </details>
  </section>

  <!-- IMPLICATIONS -->
  <section class="mb-5" aria-labelledby="meaning-heading">
    <h2 id="meaning-heading" class="h5 mb-2">What this could mean</h2>
    <p class="small text-secondary">
      Under current UK rules, you can usually take up to 25% of your pension as a tax-free lump sum
      (subject to the Lump Sum Allowance), with the remainder typically taxed as income when withdrawn.
      This page is a projection tool, not a withdrawal planner.
    </p>
    <p class="small text-secondary mb-0">
      If you’re planning drawdown, annuities, or want to understand tax implications in detail, use official guidance and/or a regulated financial adviser.
      Pension Wise (MoneyHelper) is the UK’s free, government-backed guidance route.
    </p>
  </section>

  <!-- BASIC LESSON: RULES, RISK, AND "YES BUT ALSO NO" -->
  <section class="mb-5" aria-labelledby="basics-heading">
    <h2 id="basics-heading" class="h5 mb-2">SIPP basics: rules, risk, and the “yes — but also no”</h2>

    <p class="small text-secondary">
      A SIPP is a type of personal pension where <em>you</em> choose (or delegate) how the money is invested. That can be powerful:
      you can access a broad range of funds, shares, bonds, and other assets depending on the provider.
      The trade-off is that SIPPs reward planning and discipline — and they also punish overconfidence.
    </p>

    <ul class="small text-secondary">
      <li><strong>Yes:</strong> long time horizons + consistent contributions can make compounding do the heavy lifting.</li>
      <li><strong>But also no:</strong> markets don’t deliver smooth returns, and legislation/tax rules can change.</li>
      <li><strong>Yes:</strong> tax relief can materially boost contributions.</li>
      <li><strong>But also no:</strong> withdrawal tax, allowances, charges and real-life interruptions can change outcomes.</li>
    </ul>

    <p class="small text-secondary mb-0">
      If a SIPP feels like “too much steering wheel”, there are alternatives that can still be excellent:
      <strong>Stocks &amp; Shares ISAs</strong> (tax-sheltered investing, different rules to pensions),
      <strong>Cash ISAs</strong> (lower risk, lower expected return),
      <strong>workplace pensions</strong> (often with employer contributions),
      and “set-and-forget” <strong>managed funds</strong> inside pensions/ISAs depending on provider options.
      Many people also factor in the <strong>State Pension</strong> as part of the baseline plan.
    </p>
  </section>

  <!-- WHERE TO GET PROFESSIONAL HELP -->
  <section class="mb-5" aria-labelledby="advice-heading">
    <h2 id="advice-heading" class="h5 mb-2">Where to get guidance or professional advice</h2>
    <ul class="small text-secondary mb-0">
      <li><strong>Pension Wise (MoneyHelper):</strong> free, impartial guidance appointments (not regulated advice).</li>
      <li><strong>GOV.UK / MoneyHelper:</strong> official explainers and next steps if you need help with a personal pension.</li>
      <li><strong>FCA Register:</strong> verify whether a firm/individual is authorised before paying for advice.</li>
    </ul>
  </section>

  <!-- WHY DIFFERENT -->
  <section class="mb-5" aria-labelledby="different-heading">
    <h2 id="different-heading" class="h5 mb-2">Why this tool is different</h2>
    <ul class="small text-secondary mb-0">
      <li>Uses DOB to remove age-rounding errors.</li>
      <li>Separates SIPP access age from State Pension age (they are not the same).</li>
      <li>Models net vs gross contributions (basic-rate relief at source for “net”).</li>
      <li>Uses low / mid / high outcomes instead of false precision.</li>
      <li>Outputs a complete audit trail: all inputs, derived values, formulae, and a month-by-month schedule.</li>
    </ul>
  </section>

  <!-- PROVIDERS (careful wording) -->
  <section class="mb-5" aria-labelledby="providers-heading">
    <h2 id="providers-heading" class="h5 mb-2">Choosing a SIPP provider (briefly)</h2>
    <p class="small text-secondary">
      Provider choice is a “fees + features + usability” decision. Costs can include platform fees, fund OCFs, dealing charges, and FX fees.
      This tool does not model charges — so when you compare providers, treat this projection as an optimistic baseline unless you adjust the return downwards to reflect costs.
    </p>
    <p class="small text-secondary mb-0">
      If you want a mainstream starting point to research, <strong>Hargreaves Lansdown (HL)</strong> is often shortlisted because it’s widely used and publishes clear fee information —
      but “best” depends on what you buy, how often you trade, and how much support you want. Compare against other providers for your situation.
    </p>
  </section>

  <!-- LIMITATIONS & DISCLAIMER -->
  <section class="mb-5" aria-labelledby="limits-heading">
    <h2 id="limits-heading" class="h5 mb-2">Limitations &amp; disclaimer</h2>
    <p class="small text-secondary">
      This tool is for educational purposes only. It does not model platform charges, fund fees, trading costs, inflation, behavioural changes (e.g., stopping contributions),
      career breaks, health, or future tax and pension law changes. It assumes a constant monthly contribution and a constant return rate, compounded monthly.
    </p>
    <p class="small text-secondary">
      It also does not model “protected pension ages” (scheme-specific rights), ill-health access, annual allowance tapering, or claiming higher/additional-rate relief from HMRC.
      UK minimum access age rules can change (for example, the minimum pension age is legislated to rise to 57 from April 2028).
    </p>
    <p class="small text-secondary mb-0">
      This is not regulated financial advice. If you are unsure, consider speaking to a regulated financial adviser or using official guidance services such as Pension Wise.
    </p>
  </section>

  <!-- Standard bottom meta row: Questions / Change log / Share this tool -->
  <section class="mb-5" aria-labelledby="meta-row-heading">
    <hr>
    <h2 id="meta-row-heading" class="visually-hidden">Questions, change log and sharing</h2>

    <div class="row g-4 align-items-stretch">
      <!-- QUESTIONS -->
      <div class="col-lg-4">
        <div class="questions-box h-100">
          <h3 class="h6 text-uppercase text-muted mb-2">Questions</h3>
          <p class="small text-secondary mb-1">
            If you have feedback, spot an issue, or want to suggest improvements
            to this page or tool, you’re welcome to get in touch.
          </p>
          <a href="/contact.html" class="btn btn-primary btn-sm mt-auto">Contact Alex</a>
        </div>
      </div>

      <!-- CHANGE LOG -->
      <div class="col-lg-4">
        <div class="questions-box h-100">
          <h3 class="h6 text-uppercase text-muted mb-2">Changes</h3>
          <p class="small text-secondary mb-1">
            A record of changes to this page.
          </p>
          <ul class="small text-secondary mb-0">
            <li><strong>03-06-2025</strong> – <a href="https://archive.cyberalex.uk/sipp.html" target="_blank" rel="noopener">Original Publication</a></li>
            <li><strong>23-12-2025</strong> – Modernised & Updated</li>
          </ul>
          <p class="small text-secondary text-muted">Dates are in UK format (day–month–year).</p>
        </div>
      </div>

      <!-- SHARE -->
      <div class="col-lg-4">
        <div class="share-card h-100">
          <h3 class="h6 text-uppercase text-muted mb-2">Share</h3>
          <p class="small text-secondary mb-2">
            If you’d like to share this page with someone else, you can use the short link below.
          </p>

          <div class="share-url-row mb-2">
            <span class="share-url-prefix">https://www.</span>
            <button class="share-url-main"
                    type="button"
                    data-share-url="https://www.zilchy.link/sipp">
              <span class="share-url-text">zilchy.link/sipp</span>
            </button>
          </div>

          <p class="small text-secondary share-status mb-2" aria-live="polite"></p>

          <p class="small text-secondary mb-0">
            Zilchy.link is my own open-source short-link service. Links are hand-curated, do not track or log users, and this one simply redirects back to this page.
          </p>
        </div>
      </div>
    </div>
  </section>

</main>

<footer id="site-footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/layout.js"></script>

<script>
/* =========================
   SIPP Projection Tool (Local-only)
   - Auto-fill earliest access age on DOB input
   - Allow user to increase age (min = earliest allowed)
   - Full audit trail (low/mid/high) + CSV export
   ========================= */

const HELP_TEXT = {
  accessAge: {
    title: "Access age",
    text: `
      <p class="mb-1">
        This tool defaults to the <strong>earliest age you can usually access a private pension</strong> under current UK rules.
        You can increase it if you plan to access later.
      </p>
      <p class="mb-0">
        Important: some people can access earlier via scheme-specific protected ages or ill-health. This calculator does not model those cases.
      </p>
    `
  }
};

let LAST_RUN = null; // store full outputs for CSV + audit view
let CURRENT_AUDIT_VIEW = "mid";

function clamp(n, min, max) {
  return Math.min(max, Math.max(min, n));
}

function parseMoney(id) {
  const v = parseFloat(document.getElementById(id).value);
  return isFinite(v) ? v : 0;
}

function parsePct(id) {
  const v = parseFloat(document.getElementById(id).value);
  return isFinite(v) ? v : 0;
}

function yearsBetween(d1, d2) {
  return (d2 - d1) / (365.25 * 24 * 3600 * 1000);
}

function addMonths(date, months) {
  const d = new Date(date.getTime());
  const day = d.getDate();
  d.setMonth(d.getMonth() + months);

  // Handle month rollovers (e.g., Jan 31 -> Feb)
  if (d.getDate() < day) {
    d.setDate(0);
  }
  return d;
}

/**
 * Earliest access age rule (simplified, explicit):
 * - NMPA is 55 before 6 April 2028
 * - From 6 April 2028 it is 57
 * We compute based on the user's DOB: if their 55th birthday is on/after 6 April 2028, earliest is 57, else 55.
 * (Does not model protected pension ages / ill-health.)
 */
function earliestAccessAgeFromDOB(dob) {
  const boundary = new Date("2028-04-06T00:00:00");
  const fiftyFifth = new Date(dob.getTime());
  fiftyFifth.setFullYear(fiftyFifth.getFullYear() + 55);

  return (fiftyFifth >= boundary) ? 57 : 55;
}

function renderInlineHelp(key) {
  const box = document.getElementById("inlineHelp");
  const title = document.getElementById("inlineHelpTitle");
  const text = document.getElementById("inlineHelpText");

  const h = HELP_TEXT[key];
  if (!h) return;

  title.textContent = h.title;
  text.innerHTML = h.text;
  box.classList.remove("d-none");
  box.scrollIntoView({ behavior: "smooth", block: "nearest" });
}

function wireHelp() {
  document.querySelectorAll("[data-help]").forEach(el => {
    el.addEventListener("click", () => renderInlineHelp(el.dataset.help));
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        renderInlineHelp(el.dataset.help);
      }
    });
  });
}

function onDOBChanged() {
  const dobRaw = document.getElementById("dob").value;
  const dob = new Date(dobRaw);
  const retirementAge = document.getElementById("retirementAge");

  if (isNaN(dob)) {
    retirementAge.value = "";
    retirementAge.min = 55;
    return;
  }

  const minAge = earliestAccessAgeFromDOB(dob);
  retirementAge.min = minAge;
  // If empty or below min, set to min
  const current = parseInt(retirementAge.value || "0", 10);
  if (!current || current < minAge) retirementAge.value = minAge;
}

function formatGBP(n) {
  return Math.round(n).toString();
}

/**
 * Build month-by-month schedule for a given annual rate and monthly contribution.
 * We treat each month as:
 *   start = balance
 *   growth = start * monthlyRate
 *   end = start + growth + contribution
 */
function buildSchedule({startPot, months, dob, annualRate, monthlyContributionGross}) {
  const monthlyRate = annualRate / 12;
  let balance = startPot;

  const rows = [];
  const today = new Date();

  for (let i = 1; i <= months; i++) {
    const start = balance;
    const growth = start * monthlyRate;
    const end = start + growth + monthlyContributionGross;

    // Age at that month (approx, auditable, not used for rules)
    const dateAtMonth = addMonths(today, i);
    const ageAtMonth = yearsBetween(dob, dateAtMonth);

    rows.push({
      month: i,
      age: ageAtMonth,
      start,
      growth,
      contrib: monthlyContributionGross,
      end
    });

    balance = end;
  }

  return rows;
}

function calculate() {
  const dobRaw = document.getElementById("dob").value;
  const dob = new Date(dobRaw);
  if (isNaN(dob)) return alert("Please enter your date of birth.");

  // Ensure access age auto-filled and valid
  onDOBChanged();

  const today = new Date();
  const ageNow = yearsBetween(dob, today);

  const minAccessAge = earliestAccessAgeFromDOB(dob);
  const chosenAccessAge = parseInt(document.getElementById("retirementAge").value, 10);

  if (!isFinite(chosenAccessAge)) return alert("Please enter a valid access age.");
  if (chosenAccessAge < minAccessAge) {
    return alert(`Access age cannot be below the earliest allowed under current rules for your DOB (${minAccessAge}).`);
  }
  if (chosenAccessAge > 100) {
    return alert("Access age looks unusually high. Please check and try again.");
  }

  const yearsToAccess = chosenAccessAge - ageNow;
  const monthsToAccess = Math.max(0, Math.round(yearsToAccess * 12));

  const currentPot = parseMoney("currentPot");
  const monthlyContrib = parseMoney("contribution");

  const growthPct = parsePct("growth");
  const variancePct = parsePct("variance");
  const growth = clamp(growthPct, 0.1, 20.0) / 100;
  const variance = clamp(variancePct, 0.0, 10.0) / 100;

  const type = document.getElementById("contributionType").value;
  const income = parseMoney("income"); // currently not used for additional relief; kept for transparency

  // Basic-rate relief at source modelling:
  // - If "net": user pays net, provider adds 20% to make it gross. Net = 80% of gross => gross = net / 0.8
  // - If "gross": treat as already gross
  const monthlyGross = (type === "net") ? (monthlyContrib / 0.8) : monthlyContrib;

  const lowAnnual = growth - variance;
  const midAnnual = growth;
  const highAnnual = growth + variance;

  // Build schedules
  const lowRows = buildSchedule({
    startPot: currentPot,
    months: monthsToAccess,
    dob,
    annualRate: lowAnnual,
    monthlyContributionGross: monthlyGross
  });
  const midRows = buildSchedule({
    startPot: currentPot,
    months: monthsToAccess,
    dob,
    annualRate: midAnnual,
    monthlyContributionGross: monthlyGross
  });
  const highRows = buildSchedule({
    startPot: currentPot,
    months: monthsToAccess,
    dob,
    annualRate: highAnnual,
    monthlyContributionGross: monthlyGross
  });

  const lowEnd = (lowRows.length ? lowRows[lowRows.length - 1].end : currentPot);
  const midEnd = (midRows.length ? midRows[midRows.length - 1].end : currentPot);
  const highEnd = (highRows.length ? highRows[highRows.length - 1].end : currentPot);

  // Store run for audit view + CSV
  LAST_RUN = {
    runAtISO: new Date().toISOString(),
    inputs: {
      dob: dobRaw,
      currentPot,
      monthlyContrib,
      contributionType: type,
      income: income || null,
      growthPct: growthPct,
      variancePct: variancePct,
      chosenAccessAge,
      minAccessAge
    },
    derived: {
      ageNow,
      yearsToAccess,
      monthsToAccess,
      monthlyGross,
      lowAnnual,
      midAnnual,
      highAnnual
    },
    schedules: {
      low: lowRows,
      mid: midRows,
      high: highRows
    },
    outputs: {
      lowEnd,
      midEnd,
      highEnd
    }
  };

  // Render top-line result
  document.getElementById("lowOut").textContent = formatGBP(lowEnd);
  document.getElementById("midOut").textContent = formatGBP(midEnd);
  document.getElementById("highOut").textContent = formatGBP(highEnd);
  document.getElementById("outAge").textContent = chosenAccessAge;

  // Render full workings: inputs + derived + formula
  const formula = `
    <div class="mb-2">
      <div class="mono small">
        <div><strong>Monthly update formula</strong></div>
        <div>monthlyRate = annualRate / 12</div>
        <div>growth = startBalance × monthlyRate</div>
        <div>endBalance = startBalance + growth + monthlyGrossContribution</div>
      </div>
    </div>
  `;

  const inputsBlock = `
    <div class="mb-3">
      <h3 class="h6 text-uppercase text-muted mb-2">Inputs</h3>
      <ul class="mb-0">
        <li>DOB: <span class="mono">${escapeHtml(dobRaw)}</span></li>
        <li>Current pot: £${formatGBP(currentPot)}</li>
        <li>Monthly contribution (user-entered): £${formatGBP(monthlyContrib)} (${escapeHtml(type)})</li>
        <li>Annual income: ${income ? "£" + formatGBP(income) : "<em>not provided</em>"}</li>
        <li>Expected annual return: ${growthPct.toFixed(1)}%</li>
        <li>Variance: ±${variancePct.toFixed(1)}%</li>
        <li>Chosen access age: ${chosenAccessAge}</li>
      </ul>
    </div>
  `;

  const derivedBlock = `
    <div class="mb-3">
      <h3 class="h6 text-uppercase text-muted mb-2">Derived values</h3>
      <ul class="mb-0">
        <li>Age now (years, approx): ${ageNow.toFixed(3)}</li>
        <li>Earliest access age under current rules for this DOB (simplified): ${minAccessAge}</li>
        <li>Time horizon: ${monthsToAccess} months</li>
        <li>Monthly gross contribution used in model: £${monthlyGross.toFixed(2)}</li>
        <li>Annual return assumptions:
          Low ${(lowAnnual*100).toFixed(1)}% &nbsp;|&nbsp;
          Mid ${(midAnnual*100).toFixed(1)}% &nbsp;|&nbsp;
          High ${(highAnnual*100).toFixed(1)}%
        </li>
      </ul>
      <p class="small text-secondary mt-2 mb-0">
        Note: if you selected <strong>net</strong>, the model converts it to gross using basic-rate relief at source (gross = net / 0.8).
        Higher/additional-rate relief reclaim is not modelled here.
      </p>
    </div>
  `;

  document.getElementById("workings").innerHTML = inputsBlock + derivedBlock + formula;

  // Show results + enable CSV + default audit view
  document.getElementById("results").classList.remove("d-none");
  document.getElementById("csvBtn").disabled = false;

  setAuditView("mid");
}

function setAuditView(view) {
  if (!LAST_RUN) return;
  CURRENT_AUDIT_VIEW = view;

  const rows = LAST_RUN.schedules[view] || [];
  const tbody = document.getElementById("auditBody");
  tbody.innerHTML = "";

  for (const r of rows) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.month}</td>
      <td class="mono">${r.age.toFixed(3)}</td>
      <td class="mono">${formatGBP(r.start)}</td>
      <td class="mono">${formatGBP(r.growth)}</td>
      <td class="mono">${formatGBP(r.contrib)}</td>
      <td class="mono">${formatGBP(r.end)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function downloadCSV() {
  if (!LAST_RUN) return;

  // One CSV containing three scenarios stacked, with a scenario column.
  const lines = [];
  lines.push([
    "scenario",
    "month",
    "age_years_approx",
    "start_gbp",
    "growth_gbp",
    "contribution_gbp",
    "end_gbp"
  ].join(","));

  for (const scenario of ["low","mid","high"]) {
    const rows = LAST_RUN.schedules[scenario] || [];
    for (const r of rows) {
      lines.push([
        scenario,
        r.month,
        r.age.toFixed(6),
        r.start.toFixed(2),
        r.growth.toFixed(2),
        r.contrib.toFixed(2),
        r.end.toFixed(2)
      ].join(","));
    }
  }

  // Add a short header block as comments (CSV viewers usually ignore lines starting with #)
  const meta = [];
  meta.push(`# run_at_utc=${LAST_RUN.runAtISO}`);
  meta.push(`# dob=${LAST_RUN.inputs.dob}`);
  meta.push(`# current_pot=${LAST_RUN.inputs.currentPot}`);
  meta.push(`# monthly_contrib_entered=${LAST_RUN.inputs.monthlyContrib}`);
  meta.push(`# contribution_type=${LAST_RUN.inputs.contributionType}`);
  meta.push(`# monthly_gross_used=${LAST_RUN.derived.monthlyGross.toFixed(2)}`);
  meta.push(`# growth_pct=${LAST_RUN.inputs.growthPct}`);
  meta.push(`# variance_pct=${LAST_RUN.inputs.variancePct}`);
  meta.push(`# chosen_access_age=${LAST_RUN.inputs.chosenAccessAge}`);
  meta.push(`# months_to_access=${LAST_RUN.derived.monthsToAccess}`);

  const csv = meta.join("\n") + "\n" + lines.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "sipp-audit-trail.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

// Wire events
document.addEventListener("DOMContentLoaded", () => {
  wireHelp();

  document.getElementById("dob").addEventListener("change", onDOBChanged);
  document.getElementById("dob").addEventListener("blur", onDOBChanged);

  // In case browser autofills date value
  onDOBChanged();
});
</script>

</body>
</html>
